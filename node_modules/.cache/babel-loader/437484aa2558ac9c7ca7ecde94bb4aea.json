{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.validateValue = exports.validateTree = void 0;\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nvar _configUtils = require(\"./configUtils\");\n\nvar _ruleUtils = require(\"../utils/ruleUtils\");\n\nvar _stuff = require(\"../utils/stuff\");\n\nvar _defaultUtils = require(\"../utils/defaultUtils\");\n\nvar _omit = _interopRequireDefault(require(\"lodash/omit\"));\n\nvar typeOf = function typeOf(v) {\n  if ((0, _typeof2[\"default\"])(v) == \"object\" && v !== null && Array.isArray(v)) return \"array\";else return (0, _typeof2[\"default\"])(v);\n};\n\nvar isTypeOf = function isTypeOf(v, type) {\n  if (typeOf(v) == type) return true;\n  if (type == \"number\" && !isNaN(v)) return true; //can be casted\n\n  return false;\n};\n\nvar validateTree = function validateTree(tree, _oldTree, config, oldConfig) {\n  var removeEmptyGroups = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var removeInvalidRules = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : false;\n  var c = {\n    config: config,\n    oldConfig: oldConfig,\n    removeEmptyGroups: removeEmptyGroups,\n    removeInvalidRules: removeInvalidRules\n  };\n  return validateItem(tree, [], null, {}, c);\n};\n\nexports.validateTree = validateTree;\n\nfunction validateItem(item, path, itemId, meta, c) {\n  var type = item.get(\"type\");\n  var children = item.get(\"children1\");\n\n  if ((type === \"group\" || type === \"rule_group\") && children && children.size) {\n    return validateGroup(item, path, itemId, meta, c);\n  } else if (type === \"rule\") {\n    return validateRule(item, path, itemId, meta, c);\n  } else {\n    return item;\n  }\n}\n\nfunction validateGroup(item, path, itemId, meta, c) {\n  var removeEmptyGroups = c.removeEmptyGroups;\n  var id = item.get(\"id\");\n  var children = item.get(\"children1\");\n  var oldChildren = children;\n\n  if (!id && itemId) {\n    id = itemId;\n    item = item.set(\"id\", id);\n    meta.sanitized = true;\n  } //validate children\n\n\n  var submeta = {};\n  children = children.map(function (currentChild, childId) {\n    return validateItem(currentChild, path.concat(id), childId, submeta, c);\n  });\n  if (removeEmptyGroups) children = children.filter(function (currentChild) {\n    return currentChild != undefined;\n  });\n  var sanitized = submeta.sanitized || oldChildren.size != children.size;\n\n  if (!children.size && removeEmptyGroups && path.length) {\n    sanitized = true;\n    item = undefined;\n  }\n\n  if (sanitized) meta.sanitized = true;\n  if (sanitized && item) item = item.set(\"children1\", children);\n  return item;\n}\n\nfunction validateRule(item, path, itemId, meta, c) {\n  var removeInvalidRules = c.removeInvalidRules,\n      config = c.config,\n      oldConfig = c.oldConfig;\n  var showErrorMessage = config.settings.showErrorMessage;\n  var id = item.get(\"id\");\n  var properties = item.get(\"properties\");\n  var field = properties.get(\"field\");\n  var operator = properties.get(\"operator\");\n  var operatorOptions = properties.get(\"operatorOptions\");\n  var valueSrc = properties.get(\"valueSrc\");\n  var value = properties.get(\"value\");\n  var valueError = properties.get(\"valueError\");\n  var oldSerialized = {\n    field: field,\n    operator: operator,\n    operatorOptions: operatorOptions ? operatorOptions.toJS() : {},\n    valueSrc: valueSrc ? valueSrc.toJS() : null,\n    value: value ? value.toJS() : null,\n    valueError: valueError ? valueError.toJS() : null\n  };\n\n  var _wasValid = field && operator && value && !value.find(function (v, ind) {\n    return v === undefined;\n  });\n\n  if (!id && itemId) {\n    id = itemId;\n    item = item.set(\"id\", id);\n    meta.sanitized = true;\n  } //validate field\n\n\n  var fieldDefinition = field ? (0, _configUtils.getFieldConfig)(config, field) : null;\n  if (!fieldDefinition) field = null;\n\n  if (field == null) {\n    properties = [\"operator\", \"operatorOptions\", \"valueSrc\", \"value\"].reduce(function (map, key) {\n      return map[\"delete\"](key);\n    }, properties);\n    operator = null;\n  } //validate operator\n\n\n  operator = properties.get(\"operator\");\n\n  if (operator == \"range_between\" || operator == \"range_not_between\") {\n    // fix obsolete operators\n    operator = operator == \"range_between\" ? \"between\" : \"not_between\";\n    properties = properties.set(\"operator\", operator);\n  }\n\n  var operatorDefinition = operator ? (0, _configUtils.getOperatorConfig)(config, operator, field) : null;\n  if (!operatorDefinition) operator = null;\n  var availOps = field ? (0, _ruleUtils.getOperatorsForField)(config, field) : [];\n\n  if (!availOps) {\n    console.warn(\"Type of field \".concat(field, \" is not supported\"));\n    operator = null;\n  } else if (availOps.indexOf(operator) == -1) {\n    operator = null;\n  }\n\n  if (operator == null) {\n    properties = properties[\"delete\"](\"operatorOptions\");\n    properties = properties[\"delete\"](\"valueSrc\");\n    properties = properties[\"delete\"](\"value\");\n  } //validate operator options\n\n\n  operatorOptions = properties.get(\"operatorOptions\");\n\n  var _operatorCardinality = operator ? (0, _stuff.defaultValue)(operatorDefinition.cardinality, 1) : null;\n\n  if (!operator || operatorOptions && !operatorDefinition.options) {\n    operatorOptions = null;\n    properties = properties[\"delete\"](\"operatorOptions\");\n  } else if (operator && !operatorOptions && operatorDefinition.options) {\n    operatorOptions = (0, _defaultUtils.defaultOperatorOptions)(config, operator, field);\n    properties = properties.set(\"operatorOptions\", operatorOptions);\n  } //validate values\n\n\n  valueSrc = properties.get(\"valueSrc\");\n  value = properties.get(\"value\");\n\n  var _getNewValueForFieldO = (0, _ruleUtils.getNewValueForFieldOp)(config, oldConfig, properties, field, operator, null, true),\n      newValue = _getNewValueForFieldO.newValue,\n      newValueSrc = _getNewValueForFieldO.newValueSrc,\n      newValueError = _getNewValueForFieldO.newValueError;\n\n  value = newValue;\n  valueSrc = newValueSrc;\n  valueError = newValueError;\n  properties = properties.set(\"value\", value);\n  properties = properties.set(\"valueSrc\", valueSrc);\n\n  if (showErrorMessage) {\n    properties = properties.set(\"valueError\", valueError);\n  }\n\n  var newSerialized = {\n    field: field,\n    operator: operator,\n    operatorOptions: operatorOptions ? operatorOptions.toJS() : {},\n    valueSrc: valueSrc ? valueSrc.toJS() : null,\n    value: value ? value.toJS() : null,\n    valueError: valueError ? valueError.toJS() : null\n  };\n  var sanitized = !(0, _stuff.deepEqual)(oldSerialized, newSerialized);\n  var isValid = field && operator && value && !value.find(function (v, _ind) {\n    return v === undefined;\n  });\n  if (sanitized) meta.sanitized = true;\n  if (sanitized && !isValid && removeInvalidRules) item = undefined;\n  if (sanitized && item) item = item.set(\"properties\", properties);\n  return item;\n}\n/**\n * \n * @param {bool} canFix true is useful for func values to remove bad args\n * @param {bool} isEndValue false if value is in process of editing by user\n * @param {bool} isRawValue false is used only internally from validateFuncValue\n * @return {array} [validError, fixedValue] - if validError === null and canFix == true, fixedValue can differ from value if was fixed\n */\n\n\nvar validateValue = function validateValue(config, leftField, field, operator, value, valueType, valueSrc, asyncListValues) {\n  var canFix = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var isEndValue = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var isRawValue = arguments.length > 10 && arguments[10] !== undefined ? arguments[10] : true;\n  var validError = null;\n  var fixedValue = value;\n\n  if (value != null) {\n    if (valueSrc == \"field\") {\n      var _validateFieldValue = validateFieldValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateFieldValue2 = (0, _slicedToArray2[\"default\"])(_validateFieldValue, 2);\n\n      validError = _validateFieldValue2[0];\n      fixedValue = _validateFieldValue2[1];\n    } else if (valueSrc == \"func\") {\n      var _validateFuncValue = validateFuncValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateFuncValue2 = (0, _slicedToArray2[\"default\"])(_validateFuncValue, 2);\n\n      validError = _validateFuncValue2[0];\n      fixedValue = _validateFuncValue2[1];\n    } else if (valueSrc == \"value\" || !valueSrc) {\n      var _validateNormalValue = validateNormalValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateNormalValue2 = (0, _slicedToArray2[\"default\"])(_validateNormalValue, 2);\n\n      validError = _validateNormalValue2[0];\n      fixedValue = _validateNormalValue2[1];\n    }\n\n    if (!validError) {\n      var fieldConfig = (0, _configUtils.getFieldConfig)(config, field);\n      var w = (0, _ruleUtils.getWidgetForFieldOp)(config, field, operator, valueSrc);\n      var fieldWidgetDefinition = (0, _omit[\"default\"])((0, _configUtils.getFieldWidgetConfig)(config, field, operator, w, valueSrc), [\"factory\"]);\n      var rightFieldDefinition = valueSrc == \"field\" ? (0, _configUtils.getFieldConfig)(config, value) : null;\n      var fieldSettings = fieldWidgetDefinition; // widget definition merged with fieldSettings\n\n      var fn = fieldWidgetDefinition.validateValue;\n\n      if (typeof fn == \"function\") {\n        var args = [fixedValue, fieldSettings];\n        if (valueSrc == \"field\") args.push(rightFieldDefinition);\n        var validResult = fn.apply(void 0, args);\n\n        if (typeof validResult == \"boolean\") {\n          if (validResult == false) validError = \"Invalid value\";\n        } else {\n          validError = validResult;\n        }\n      }\n    }\n  }\n\n  if (isRawValue && validError) {\n    console.warn(\"[RAQB validate]\", \"Field \".concat(field, \": \").concat(validError));\n  }\n\n  return [validError, validError ? value : fixedValue];\n};\n\nexports.validateValue = validateValue;\n\nvar validateValueInList = function validateValueInList(value, listValues) {\n  if (value instanceof Array) {\n    for (var i = 0; i < value.length; i++) {\n      var vv = (0, _stuff.getItemInListValues)(listValues, value[i]);\n\n      if (vv == undefined) {\n        return [\"Value \".concat(value[i], \" is not in list of values\"), value];\n      } else {\n        value[i] = vv.value;\n      }\n    }\n  } else {\n    var _vv = (0, _stuff.getItemInListValues)(listValues, value);\n\n    if (_vv == undefined) {\n      return [\"Value \".concat(value, \" is not in list of values\"), value];\n    } else {\n      value = _vv.value;\n    }\n  }\n\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateNormalValue = function validateNormalValue(leftField, field, value, valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fixedValue = value;\n  var fieldConfig = (0, _configUtils.getFieldConfig)(config, field);\n  var w = (0, _ruleUtils.getWidgetForFieldOp)(config, field, operator, valueSrc);\n  var wConfig = config.widgets[w];\n  var wType = wConfig.type;\n  var jsType = wConfig.jsType;\n  var fieldSettings = fieldConfig.fieldSettings;\n  if (valueType != wType) return [\"Value should have type \".concat(wType, \", but got value of type \").concat(valueType), value];\n\n  if (jsType && !isTypeOf(value, jsType) && !fieldSettings.listValues) {\n    //tip: can skip tye check for listValues\n    return [\"Value should have JS type \".concat(jsType, \", but got value of type \").concat((0, _typeof2[\"default\"])(value)), value];\n  }\n\n  if (fieldSettings) {\n    var listValues = asyncListValues || fieldSettings.listValues;\n\n    if (listValues && !fieldSettings.allowCustomValues) {\n      return validateValueInList(value, listValues);\n    }\n\n    if (fieldSettings.min != null && value < fieldSettings.min) {\n      return [\"Value \".concat(value, \" < min \").concat(fieldSettings.min), value];\n    }\n\n    if (fieldSettings.max != null && value > fieldSettings.max) {\n      return [\"Value \".concat(value, \" > max \").concat(fieldSettings.max), value];\n    }\n  }\n\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateFieldValue = function validateFieldValue(leftField, field, value, _valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fieldSeparator = config.settings.fieldSeparator;\n  var leftFieldStr = Array.isArray(leftField) ? leftField.join(fieldSeparator) : leftField;\n  var rightFieldStr = Array.isArray(value) ? value.join(fieldSeparator) : value;\n  var rightFieldDefinition = (0, _configUtils.getFieldConfig)(config, value);\n  if (!rightFieldDefinition) return [\"Unknown field \".concat(value), value];\n  if (rightFieldStr == leftFieldStr) return [\"Can't compare field \".concat(leftField, \" with itself\"), value];\n  if (valueType && valueType != rightFieldDefinition.type) return [\"Field \".concat(value, \" is of type \").concat(rightFieldDefinition.type, \", but expected \").concat(valueType), value];\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateFuncValue = function validateFuncValue(leftField, field, value, _valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fixedValue = value;\n\n  if (value) {\n    var funcKey = value.get(\"func\");\n\n    if (funcKey) {\n      var funcConfig = (0, _configUtils.getFuncConfig)(config, funcKey);\n\n      if (funcConfig) {\n        if (valueType && funcConfig.returnType != valueType) return [\"Function \".concat(funcKey, \" should return value of type \").concat(funcConfig.returnType, \", but got \").concat(valueType), value];\n\n        for (var argKey in funcConfig.args) {\n          var argConfig = funcConfig.args[argKey];\n          var args = fixedValue.get(\"args\");\n          var argVal = args ? args.get(argKey) : undefined;\n          var fieldDef = (0, _configUtils.getFieldConfig)(config, argConfig);\n          var argValue = argVal ? argVal.get(\"value\") : undefined;\n          var argValueSrc = argVal ? argVal.get(\"valueSrc\") : undefined;\n\n          if (argValue !== undefined) {\n            var _validateValue = validateValue(config, leftField, fieldDef, operator, argValue, argConfig.type, argValueSrc, asyncListValues, canFix, isEndValue, false),\n                _validateValue2 = (0, _slicedToArray2[\"default\"])(_validateValue, 2),\n                argValidError = _validateValue2[0],\n                fixedArgVal = _validateValue2[1];\n\n            if (argValidError !== null) {\n              if (canFix) {\n                fixedValue = fixedValue.deleteIn([\"args\", argKey]);\n\n                if (argConfig.defaultValue !== undefined) {\n                  fixedValue = fixedValue.setIn([\"args\", argKey, \"value\"], argConfig.defaultValue);\n                  fixedValue = fixedValue.setIn([\"args\", argKey, \"valueSrc\"], \"value\");\n                }\n              } else {\n                return [\"Invalid value of arg \".concat(argKey, \" for func \").concat(funcKey, \": \").concat(argValidError), value];\n              }\n            } else if (fixedArgVal !== argValue) {\n              fixedValue = fixedValue.setIn([\"args\", argKey, \"value\"], fixedArgVal);\n            }\n          } else if (isEndValue && argConfig.defaultValue === undefined && !canFix) {\n            return [\"Value of arg \".concat(argKey, \" for func \").concat(funcKey, \" is required\"), value];\n          }\n        }\n      } else return [\"Unknown function \".concat(funcKey), value];\n    } // else it's not function value\n\n  } // empty value\n\n\n  return [null, fixedValue];\n};","map":{"version":3,"sources":["D:/node_modules/react-awesome-query-builder/lib/utils/validation.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","validateValue","validateTree","_slicedToArray2","_typeof2","_configUtils","_ruleUtils","_stuff","_defaultUtils","_omit","typeOf","v","Array","isArray","isTypeOf","type","isNaN","tree","_oldTree","config","oldConfig","removeEmptyGroups","arguments","length","undefined","removeInvalidRules","c","validateItem","item","path","itemId","meta","get","children","size","validateGroup","validateRule","id","oldChildren","set","sanitized","submeta","map","currentChild","childId","concat","filter","showErrorMessage","settings","properties","field","operator","operatorOptions","valueSrc","valueError","oldSerialized","toJS","_wasValid","find","ind","fieldDefinition","getFieldConfig","reduce","key","operatorDefinition","getOperatorConfig","availOps","getOperatorsForField","console","warn","indexOf","_operatorCardinality","defaultValue","cardinality","options","defaultOperatorOptions","_getNewValueForFieldO","getNewValueForFieldOp","newValue","newValueSrc","newValueError","newSerialized","deepEqual","isValid","_ind","leftField","valueType","asyncListValues","canFix","isEndValue","isRawValue","validError","fixedValue","_validateFieldValue","validateFieldValue","_validateFieldValue2","_validateFuncValue","validateFuncValue","_validateFuncValue2","_validateNormalValue","validateNormalValue","_validateNormalValue2","fieldConfig","w","getWidgetForFieldOp","fieldWidgetDefinition","getFieldWidgetConfig","rightFieldDefinition","fieldSettings","fn","args","push","validResult","apply","validateValueInList","listValues","i","vv","getItemInListValues","_vv","wConfig","widgets","wType","jsType","allowCustomValues","min","max","_valueSrc","fieldSeparator","leftFieldStr","join","rightFieldStr","funcKey","funcConfig","getFuncConfig","returnType","argKey","argConfig","argVal","fieldDef","argValue","argValueSrc","_validateValue","_validateValue2","argValidError","fixedArgVal","deleteIn","setIn"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.validateValue = exports.validateTree = void 0;\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _typeof2 = _interopRequireDefault(require(\"@babel/runtime/helpers/typeof\"));\n\nvar _configUtils = require(\"./configUtils\");\n\nvar _ruleUtils = require(\"../utils/ruleUtils\");\n\nvar _stuff = require(\"../utils/stuff\");\n\nvar _defaultUtils = require(\"../utils/defaultUtils\");\n\nvar _omit = _interopRequireDefault(require(\"lodash/omit\"));\n\nvar typeOf = function typeOf(v) {\n  if ((0, _typeof2[\"default\"])(v) == \"object\" && v !== null && Array.isArray(v)) return \"array\";else return (0, _typeof2[\"default\"])(v);\n};\n\nvar isTypeOf = function isTypeOf(v, type) {\n  if (typeOf(v) == type) return true;\n  if (type == \"number\" && !isNaN(v)) return true; //can be casted\n\n  return false;\n};\n\nvar validateTree = function validateTree(tree, _oldTree, config, oldConfig) {\n  var removeEmptyGroups = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  var removeInvalidRules = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : false;\n  var c = {\n    config: config,\n    oldConfig: oldConfig,\n    removeEmptyGroups: removeEmptyGroups,\n    removeInvalidRules: removeInvalidRules\n  };\n  return validateItem(tree, [], null, {}, c);\n};\n\nexports.validateTree = validateTree;\n\nfunction validateItem(item, path, itemId, meta, c) {\n  var type = item.get(\"type\");\n  var children = item.get(\"children1\");\n\n  if ((type === \"group\" || type === \"rule_group\") && children && children.size) {\n    return validateGroup(item, path, itemId, meta, c);\n  } else if (type === \"rule\") {\n    return validateRule(item, path, itemId, meta, c);\n  } else {\n    return item;\n  }\n}\n\nfunction validateGroup(item, path, itemId, meta, c) {\n  var removeEmptyGroups = c.removeEmptyGroups;\n  var id = item.get(\"id\");\n  var children = item.get(\"children1\");\n  var oldChildren = children;\n\n  if (!id && itemId) {\n    id = itemId;\n    item = item.set(\"id\", id);\n    meta.sanitized = true;\n  } //validate children\n\n\n  var submeta = {};\n  children = children.map(function (currentChild, childId) {\n    return validateItem(currentChild, path.concat(id), childId, submeta, c);\n  });\n  if (removeEmptyGroups) children = children.filter(function (currentChild) {\n    return currentChild != undefined;\n  });\n  var sanitized = submeta.sanitized || oldChildren.size != children.size;\n\n  if (!children.size && removeEmptyGroups && path.length) {\n    sanitized = true;\n    item = undefined;\n  }\n\n  if (sanitized) meta.sanitized = true;\n  if (sanitized && item) item = item.set(\"children1\", children);\n  return item;\n}\n\nfunction validateRule(item, path, itemId, meta, c) {\n  var removeInvalidRules = c.removeInvalidRules,\n      config = c.config,\n      oldConfig = c.oldConfig;\n  var showErrorMessage = config.settings.showErrorMessage;\n  var id = item.get(\"id\");\n  var properties = item.get(\"properties\");\n  var field = properties.get(\"field\");\n  var operator = properties.get(\"operator\");\n  var operatorOptions = properties.get(\"operatorOptions\");\n  var valueSrc = properties.get(\"valueSrc\");\n  var value = properties.get(\"value\");\n  var valueError = properties.get(\"valueError\");\n  var oldSerialized = {\n    field: field,\n    operator: operator,\n    operatorOptions: operatorOptions ? operatorOptions.toJS() : {},\n    valueSrc: valueSrc ? valueSrc.toJS() : null,\n    value: value ? value.toJS() : null,\n    valueError: valueError ? valueError.toJS() : null\n  };\n\n  var _wasValid = field && operator && value && !value.find(function (v, ind) {\n    return v === undefined;\n  });\n\n  if (!id && itemId) {\n    id = itemId;\n    item = item.set(\"id\", id);\n    meta.sanitized = true;\n  } //validate field\n\n\n  var fieldDefinition = field ? (0, _configUtils.getFieldConfig)(config, field) : null;\n  if (!fieldDefinition) field = null;\n\n  if (field == null) {\n    properties = [\"operator\", \"operatorOptions\", \"valueSrc\", \"value\"].reduce(function (map, key) {\n      return map[\"delete\"](key);\n    }, properties);\n    operator = null;\n  } //validate operator\n\n\n  operator = properties.get(\"operator\");\n\n  if (operator == \"range_between\" || operator == \"range_not_between\") {\n    // fix obsolete operators\n    operator = operator == \"range_between\" ? \"between\" : \"not_between\";\n    properties = properties.set(\"operator\", operator);\n  }\n\n  var operatorDefinition = operator ? (0, _configUtils.getOperatorConfig)(config, operator, field) : null;\n  if (!operatorDefinition) operator = null;\n  var availOps = field ? (0, _ruleUtils.getOperatorsForField)(config, field) : [];\n\n  if (!availOps) {\n    console.warn(\"Type of field \".concat(field, \" is not supported\"));\n    operator = null;\n  } else if (availOps.indexOf(operator) == -1) {\n    operator = null;\n  }\n\n  if (operator == null) {\n    properties = properties[\"delete\"](\"operatorOptions\");\n    properties = properties[\"delete\"](\"valueSrc\");\n    properties = properties[\"delete\"](\"value\");\n  } //validate operator options\n\n\n  operatorOptions = properties.get(\"operatorOptions\");\n\n  var _operatorCardinality = operator ? (0, _stuff.defaultValue)(operatorDefinition.cardinality, 1) : null;\n\n  if (!operator || operatorOptions && !operatorDefinition.options) {\n    operatorOptions = null;\n    properties = properties[\"delete\"](\"operatorOptions\");\n  } else if (operator && !operatorOptions && operatorDefinition.options) {\n    operatorOptions = (0, _defaultUtils.defaultOperatorOptions)(config, operator, field);\n    properties = properties.set(\"operatorOptions\", operatorOptions);\n  } //validate values\n\n\n  valueSrc = properties.get(\"valueSrc\");\n  value = properties.get(\"value\");\n\n  var _getNewValueForFieldO = (0, _ruleUtils.getNewValueForFieldOp)(config, oldConfig, properties, field, operator, null, true),\n      newValue = _getNewValueForFieldO.newValue,\n      newValueSrc = _getNewValueForFieldO.newValueSrc,\n      newValueError = _getNewValueForFieldO.newValueError;\n\n  value = newValue;\n  valueSrc = newValueSrc;\n  valueError = newValueError;\n  properties = properties.set(\"value\", value);\n  properties = properties.set(\"valueSrc\", valueSrc);\n\n  if (showErrorMessage) {\n    properties = properties.set(\"valueError\", valueError);\n  }\n\n  var newSerialized = {\n    field: field,\n    operator: operator,\n    operatorOptions: operatorOptions ? operatorOptions.toJS() : {},\n    valueSrc: valueSrc ? valueSrc.toJS() : null,\n    value: value ? value.toJS() : null,\n    valueError: valueError ? valueError.toJS() : null\n  };\n  var sanitized = !(0, _stuff.deepEqual)(oldSerialized, newSerialized);\n  var isValid = field && operator && value && !value.find(function (v, _ind) {\n    return v === undefined;\n  });\n  if (sanitized) meta.sanitized = true;\n  if (sanitized && !isValid && removeInvalidRules) item = undefined;\n  if (sanitized && item) item = item.set(\"properties\", properties);\n  return item;\n}\n/**\n * \n * @param {bool} canFix true is useful for func values to remove bad args\n * @param {bool} isEndValue false if value is in process of editing by user\n * @param {bool} isRawValue false is used only internally from validateFuncValue\n * @return {array} [validError, fixedValue] - if validError === null and canFix == true, fixedValue can differ from value if was fixed\n */\n\n\nvar validateValue = function validateValue(config, leftField, field, operator, value, valueType, valueSrc, asyncListValues) {\n  var canFix = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var isEndValue = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var isRawValue = arguments.length > 10 && arguments[10] !== undefined ? arguments[10] : true;\n  var validError = null;\n  var fixedValue = value;\n\n  if (value != null) {\n    if (valueSrc == \"field\") {\n      var _validateFieldValue = validateFieldValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateFieldValue2 = (0, _slicedToArray2[\"default\"])(_validateFieldValue, 2);\n\n      validError = _validateFieldValue2[0];\n      fixedValue = _validateFieldValue2[1];\n    } else if (valueSrc == \"func\") {\n      var _validateFuncValue = validateFuncValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateFuncValue2 = (0, _slicedToArray2[\"default\"])(_validateFuncValue, 2);\n\n      validError = _validateFuncValue2[0];\n      fixedValue = _validateFuncValue2[1];\n    } else if (valueSrc == \"value\" || !valueSrc) {\n      var _validateNormalValue = validateNormalValue(leftField, field, value, valueSrc, valueType, asyncListValues, config, operator, isEndValue, canFix);\n\n      var _validateNormalValue2 = (0, _slicedToArray2[\"default\"])(_validateNormalValue, 2);\n\n      validError = _validateNormalValue2[0];\n      fixedValue = _validateNormalValue2[1];\n    }\n\n    if (!validError) {\n      var fieldConfig = (0, _configUtils.getFieldConfig)(config, field);\n      var w = (0, _ruleUtils.getWidgetForFieldOp)(config, field, operator, valueSrc);\n      var fieldWidgetDefinition = (0, _omit[\"default\"])((0, _configUtils.getFieldWidgetConfig)(config, field, operator, w, valueSrc), [\"factory\"]);\n      var rightFieldDefinition = valueSrc == \"field\" ? (0, _configUtils.getFieldConfig)(config, value) : null;\n      var fieldSettings = fieldWidgetDefinition; // widget definition merged with fieldSettings\n\n      var fn = fieldWidgetDefinition.validateValue;\n\n      if (typeof fn == \"function\") {\n        var args = [fixedValue, fieldSettings];\n        if (valueSrc == \"field\") args.push(rightFieldDefinition);\n        var validResult = fn.apply(void 0, args);\n\n        if (typeof validResult == \"boolean\") {\n          if (validResult == false) validError = \"Invalid value\";\n        } else {\n          validError = validResult;\n        }\n      }\n    }\n  }\n\n  if (isRawValue && validError) {\n    console.warn(\"[RAQB validate]\", \"Field \".concat(field, \": \").concat(validError));\n  }\n\n  return [validError, validError ? value : fixedValue];\n};\n\nexports.validateValue = validateValue;\n\nvar validateValueInList = function validateValueInList(value, listValues) {\n  if (value instanceof Array) {\n    for (var i = 0; i < value.length; i++) {\n      var vv = (0, _stuff.getItemInListValues)(listValues, value[i]);\n\n      if (vv == undefined) {\n        return [\"Value \".concat(value[i], \" is not in list of values\"), value];\n      } else {\n        value[i] = vv.value;\n      }\n    }\n  } else {\n    var _vv = (0, _stuff.getItemInListValues)(listValues, value);\n\n    if (_vv == undefined) {\n      return [\"Value \".concat(value, \" is not in list of values\"), value];\n    } else {\n      value = _vv.value;\n    }\n  }\n\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateNormalValue = function validateNormalValue(leftField, field, value, valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fixedValue = value;\n  var fieldConfig = (0, _configUtils.getFieldConfig)(config, field);\n  var w = (0, _ruleUtils.getWidgetForFieldOp)(config, field, operator, valueSrc);\n  var wConfig = config.widgets[w];\n  var wType = wConfig.type;\n  var jsType = wConfig.jsType;\n  var fieldSettings = fieldConfig.fieldSettings;\n  if (valueType != wType) return [\"Value should have type \".concat(wType, \", but got value of type \").concat(valueType), value];\n\n  if (jsType && !isTypeOf(value, jsType) && !fieldSettings.listValues) {\n    //tip: can skip tye check for listValues\n    return [\"Value should have JS type \".concat(jsType, \", but got value of type \").concat((0, _typeof2[\"default\"])(value)), value];\n  }\n\n  if (fieldSettings) {\n    var listValues = asyncListValues || fieldSettings.listValues;\n\n    if (listValues && !fieldSettings.allowCustomValues) {\n      return validateValueInList(value, listValues);\n    }\n\n    if (fieldSettings.min != null && value < fieldSettings.min) {\n      return [\"Value \".concat(value, \" < min \").concat(fieldSettings.min), value];\n    }\n\n    if (fieldSettings.max != null && value > fieldSettings.max) {\n      return [\"Value \".concat(value, \" > max \").concat(fieldSettings.max), value];\n    }\n  }\n\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateFieldValue = function validateFieldValue(leftField, field, value, _valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fieldSeparator = config.settings.fieldSeparator;\n  var leftFieldStr = Array.isArray(leftField) ? leftField.join(fieldSeparator) : leftField;\n  var rightFieldStr = Array.isArray(value) ? value.join(fieldSeparator) : value;\n  var rightFieldDefinition = (0, _configUtils.getFieldConfig)(config, value);\n  if (!rightFieldDefinition) return [\"Unknown field \".concat(value), value];\n  if (rightFieldStr == leftFieldStr) return [\"Can't compare field \".concat(leftField, \" with itself\"), value];\n  if (valueType && valueType != rightFieldDefinition.type) return [\"Field \".concat(value, \" is of type \").concat(rightFieldDefinition.type, \", but expected \").concat(valueType), value];\n  return [null, value];\n};\n/**\n* \n*/\n\n\nvar validateFuncValue = function validateFuncValue(leftField, field, value, _valueSrc, valueType, asyncListValues, config) {\n  var operator = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : null;\n  var isEndValue = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  var canFix = arguments.length > 9 && arguments[9] !== undefined ? arguments[9] : false;\n  var fixedValue = value;\n\n  if (value) {\n    var funcKey = value.get(\"func\");\n\n    if (funcKey) {\n      var funcConfig = (0, _configUtils.getFuncConfig)(config, funcKey);\n\n      if (funcConfig) {\n        if (valueType && funcConfig.returnType != valueType) return [\"Function \".concat(funcKey, \" should return value of type \").concat(funcConfig.returnType, \", but got \").concat(valueType), value];\n\n        for (var argKey in funcConfig.args) {\n          var argConfig = funcConfig.args[argKey];\n          var args = fixedValue.get(\"args\");\n          var argVal = args ? args.get(argKey) : undefined;\n          var fieldDef = (0, _configUtils.getFieldConfig)(config, argConfig);\n          var argValue = argVal ? argVal.get(\"value\") : undefined;\n          var argValueSrc = argVal ? argVal.get(\"valueSrc\") : undefined;\n\n          if (argValue !== undefined) {\n            var _validateValue = validateValue(config, leftField, fieldDef, operator, argValue, argConfig.type, argValueSrc, asyncListValues, canFix, isEndValue, false),\n                _validateValue2 = (0, _slicedToArray2[\"default\"])(_validateValue, 2),\n                argValidError = _validateValue2[0],\n                fixedArgVal = _validateValue2[1];\n\n            if (argValidError !== null) {\n              if (canFix) {\n                fixedValue = fixedValue.deleteIn([\"args\", argKey]);\n\n                if (argConfig.defaultValue !== undefined) {\n                  fixedValue = fixedValue.setIn([\"args\", argKey, \"value\"], argConfig.defaultValue);\n                  fixedValue = fixedValue.setIn([\"args\", argKey, \"valueSrc\"], \"value\");\n                }\n              } else {\n                return [\"Invalid value of arg \".concat(argKey, \" for func \").concat(funcKey, \": \").concat(argValidError), value];\n              }\n            } else if (fixedArgVal !== argValue) {\n              fixedValue = fixedValue.setIn([\"args\", argKey, \"value\"], fixedArgVal);\n            }\n          } else if (isEndValue && argConfig.defaultValue === undefined && !canFix) {\n            return [\"Value of arg \".concat(argKey, \" for func \").concat(funcKey, \" is required\"), value];\n          }\n        }\n      } else return [\"Unknown function \".concat(funcKey), value];\n    } // else it's not function value\n\n  } // empty value\n\n\n  return [null, fixedValue];\n};"]},"metadata":{},"sourceType":"script"}