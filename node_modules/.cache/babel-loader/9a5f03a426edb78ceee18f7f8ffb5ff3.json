{"ast":null,"code":"import * as tslib_1 from \"tslib\";\nimport { NodeSelection, Plugin, PluginKey } from \"prosemirror-state\";\nimport { Decoration, DecorationSet } from \"prosemirror-view\";\nimport { changeStylesString } from \"../utils\";\nexport var imageResizeKey = new PluginKey('image-resize');\nvar directions = {\n  'southeast': {\n    x: 1,\n    y: 1\n  },\n  'east': {\n    x: 1,\n    y: 0\n  },\n  'south': {\n    x: 0,\n    y: 1\n  },\n  'north': {\n    x: 0,\n    y: -1\n  },\n  'west': {\n    x: -1,\n    y: 0\n  },\n  'southwest': {\n    x: -1,\n    y: 1\n  },\n  'northwest': {\n    x: -1,\n    y: -1\n  },\n  'northeast': {\n    x: 1,\n    y: -1\n  } // top right\n\n};\nvar handles = Object.keys(directions);\n\nvar setSize = function (domNode, sizeType, value) {\n  domNode.style[sizeType] = value + 'px';\n};\n\nvar reSize = /[^\\-]width:|[^\\-]height:/;\nvar reAnyValue = /^.+$/;\n\nvar ResizeState =\n/** @class */\nfunction () {\n  function ResizeState(activeHandle, dragging, rect, nodePosition) {\n    this.activeHandle = activeHandle;\n    this.dragging = dragging;\n    this.rect = rect;\n    this.nodePosition = nodePosition;\n  }\n\n  ResizeState.prototype.apply = function (tr) {\n    var state = this,\n        next = tr.getMeta(imageResizeKey);\n\n    if (next) {\n      return new ResizeState(next.activeHandle, next.setDragging, next.rect, next.nodePosition);\n    }\n\n    return state;\n  };\n\n  return ResizeState;\n}();\n\nvar handleMouseMove = function (view, event, options) {\n  var state = imageResizeKey.getState(view.state);\n  var rect = state.rect,\n      dragging = state.dragging,\n      nodePosition = state.nodePosition,\n      activeHandle = state.activeHandle;\n\n  if (!dragging || !rect) {\n    return;\n  }\n\n  var img = view.nodeDOM(nodePosition);\n  var dir = directions[activeHandle];\n  var diffX = (event.clientX - dragging.startX) * dir.x;\n  var diffY = (event.clientY - dragging.startY) * dir.y;\n  var width = dir.x ? diffX + img.width : rect.width;\n  var height = dir.y ? diffY + img.height : rect.height;\n\n  if (options.lockRatio && dir.x && dir.y) {\n    var ratio = Math.min(width / img.width, height / img.height);\n    var lockWidth = img.width * ratio;\n    var lockHeight = img.height * ratio;\n    dragging.startX = event.clientX - (width - lockWidth) * dir.x;\n    dragging.startY = event.clientY - (height - lockHeight) * dir.y;\n    width = lockWidth;\n    height = lockHeight;\n  } else {\n    dragging.startX = dir.x ? event.clientX : dragging.startX;\n    dragging.startY = dir.y ? event.clientY : dragging.startY;\n  }\n\n  setSize(img, 'width', width);\n  setSize(img, 'height', height);\n  rect.top = img.offsetTop;\n  rect.left = img.offsetLeft;\n  rect.width = img.offsetWidth;\n  rect.height = img.offsetHeight;\n  var handlesWrapper = img.nextElementSibling;\n  handlesWrapper.style.width = rect.width + 'px';\n  handlesWrapper.style.height = rect.height + 'px';\n  handlesWrapper.style.top = rect.top + 'px';\n  handlesWrapper.style.left = rect.left + 'px';\n};\n\nvar handleMouseUp = function (view) {\n  var _a = imageResizeKey.getState(view.state),\n      rect = _a.rect,\n      dragging = _a.dragging,\n      nodePosition = _a.nodePosition;\n\n  if (dragging && rect) {\n    var selection = view.state.selection;\n\n    if (selection instanceof NodeSelection) {\n      var currAttrs = selection.node.attrs;\n      var width = rect.width;\n      var height = rect.height;\n      var attrs = void 0;\n\n      if (reSize.test(currAttrs.style || '')) {\n        var changedWidth = changeStylesString(currAttrs.style, {\n          style: 'width',\n          value: reAnyValue,\n          newValue: width + 'px'\n        });\n        var style = changeStylesString(changedWidth.style || '', {\n          style: 'height',\n          value: reAnyValue,\n          newValue: height + 'px'\n        }).style;\n        attrs = tslib_1.__assign({}, currAttrs, {\n          style: style\n        });\n      } else {\n        attrs = tslib_1.__assign({}, currAttrs, {\n          width: width,\n          height: height\n        });\n      }\n\n      var newImage = selection.node.type.createAndFill(attrs);\n\n      if (newImage) {\n        var tr = view.state.tr;\n        tr.replaceWith(nodePosition, nodePosition + 1, newImage);\n        tr.setSelection(NodeSelection.create(tr.doc, nodePosition));\n        tr.setMeta('commandName', 'image-resize');\n        tr.setMeta('args', attrs);\n        tr.setMeta(imageResizeKey, {\n          setDragging: null,\n          activeHandle: null,\n          rect: rect,\n          nodePosition: nodePosition\n        });\n        view.dispatch(tr);\n      }\n    }\n  }\n};\n\nvar handleMouseDown = function (view, event, options) {\n  var target = event.target;\n  var activeHandle = target.getAttribute('data-direction');\n\n  if (!activeHandle) {\n    return false;\n  }\n\n  var resizeState = imageResizeKey.getState(view.state);\n  event.preventDefault();\n  var transaction = view.state.tr;\n  transaction.setMeta(imageResizeKey, {\n    setDragging: {\n      startX: event.clientX,\n      startY: event.clientY\n    },\n    activeHandle: activeHandle,\n    rect: resizeState.rect,\n    nodePosition: resizeState.nodePosition\n  });\n  transaction.setMeta('addToHistory', false);\n  view.dispatch(transaction);\n\n  function move(e) {\n    handleMouseMove(view, e, options);\n  }\n\n  function finish(e) {\n    e.view.removeEventListener('mouseup', finish);\n    e.view.removeEventListener('mousemove', move);\n    handleMouseUp(view);\n  }\n\n  event.view.addEventListener('mouseup', finish);\n  event.view.addEventListener('mousemove', move);\n  return true;\n};\n\nexport var imageResizing = function (options) {\n  if (options === void 0) {\n    options = {\n      node: 'image',\n      lockRatio: true\n    };\n  }\n\n  return new Plugin({\n    key: imageResizeKey,\n    view: function (viewObj) {\n      return {\n        resize: function () {\n          if (imageResizeKey.getState(viewObj.state).rect) {\n            viewObj.dispatch(viewObj.state.tr.setMeta('resize', true));\n          }\n        },\n\n        get window() {\n          return viewObj.dom.ownerDocument && viewObj.dom.ownerDocument.defaultView;\n        },\n\n        attachResize: function () {\n          var win = this.window;\n\n          if (win) {\n            win.removeEventListener('resize', this.resize);\n            win.addEventListener('resize', this.resize);\n          }\n        },\n        removeResize: function () {\n          var win = this.window;\n\n          if (win) {\n            win.removeEventListener('resize', this.resize);\n          }\n        },\n        update: function (view, prevState) {\n          var state = view.state;\n          var selection = state.selection;\n          var nodeType = state.schema.nodes[options.node];\n          var pluginState = imageResizeKey.getState(state);\n          var prevRect = pluginState.rect;\n\n          if (selection instanceof NodeSelection && nodeType === selection.node.type) {\n            var img = view.nodeDOM(selection.from);\n            var rect = {\n              top: img.offsetTop,\n              left: img.offsetLeft,\n              width: img.offsetWidth,\n              height: img.offsetHeight\n            };\n\n            if (!prevState.selection.eq(selection) || prevRect && (prevRect.width !== rect.width || prevRect.height !== rect.height || prevRect.top !== rect.top || prevRect.left !== rect.left)) {\n              var tr = state.tr;\n              tr.setMeta(imageResizeKey, {\n                rect: rect,\n                nodePosition: selection.from\n              });\n              view.dispatch(tr);\n              this.attachResize();\n            }\n          } else if (prevRect) {\n            pluginState.rect = null;\n            pluginState.nodePosition = -1;\n          }\n        },\n        destroy: function () {\n          this.removeResize();\n        }\n      };\n    },\n    state: {\n      init: function () {\n        return new ResizeState('', null, null, -1);\n      },\n      apply: function (tr, prev) {\n        return prev.apply(tr);\n      }\n    },\n    props: {\n      handleDOMEvents: {\n        mousedown: function (view, event) {\n          return handleMouseDown(view, event, options);\n        }\n      },\n      decorations: function (state) {\n        var selection = state.selection;\n        var nodeType = state.schema.nodes[options.node];\n        var rect = imageResizeKey.getState(state).rect;\n\n        if (rect && selection instanceof NodeSelection && nodeType === selection.node.type) {\n          var wrapper = document.createElement('div');\n          wrapper.className = 'k-editor-resize-handles-wrapper';\n          wrapper.style.width = rect.width + 'px';\n          wrapper.style.height = rect.height + 'px';\n          wrapper.style.top = rect.top + 'px';\n          wrapper.style.left = rect.left + 'px';\n\n          for (var i = 0; i < handles.length; i++) {\n            var dom = document.createElement('div');\n            dom.className = 'k-editor-resize-handle ' + handles[i];\n            dom.setAttribute('data-direction', handles[i]);\n            wrapper.appendChild(dom);\n          }\n\n          return DecorationSet.create(state.doc, [Decoration.widget(state.selection.from + 1, wrapper)]);\n        }\n\n        return DecorationSet.empty;\n      }\n    }\n  });\n};","map":{"version":3,"sources":["D:/Postgres_workingFolder/QuaLISWeb/node_modules/@progress/kendo-editor-common/dist/es/plugins/image-resize.js"],"names":["tslib_1","NodeSelection","Plugin","PluginKey","Decoration","DecorationSet","changeStylesString","imageResizeKey","directions","x","y","handles","Object","keys","setSize","domNode","sizeType","value","style","reSize","reAnyValue","ResizeState","activeHandle","dragging","rect","nodePosition","prototype","apply","tr","state","next","getMeta","setDragging","handleMouseMove","view","event","options","getState","img","nodeDOM","dir","diffX","clientX","startX","diffY","clientY","startY","width","height","lockRatio","ratio","Math","min","lockWidth","lockHeight","top","offsetTop","left","offsetLeft","offsetWidth","offsetHeight","handlesWrapper","nextElementSibling","handleMouseUp","_a","selection","currAttrs","node","attrs","test","changedWidth","newValue","__assign","newImage","type","createAndFill","replaceWith","setSelection","create","doc","setMeta","dispatch","handleMouseDown","target","getAttribute","resizeState","preventDefault","transaction","move","e","finish","removeEventListener","addEventListener","imageResizing","key","viewObj","resize","window","dom","ownerDocument","defaultView","attachResize","win","removeResize","update","prevState","nodeType","schema","nodes","pluginState","prevRect","from","eq","destroy","init","prev","props","handleDOMEvents","mousedown","decorations","wrapper","document","createElement","className","i","length","setAttribute","appendChild","widget","empty"],"mappings":"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","sourcesContent":["import * as tslib_1 from \"tslib\";\nimport { NodeSelection, Plugin, PluginKey } from \"prosemirror-state\";\nimport { Decoration, DecorationSet } from \"prosemirror-view\";\nimport { changeStylesString } from \"../utils\";\nexport var imageResizeKey = new PluginKey('image-resize');\nvar directions = {\n    'southeast': { x: 1, y: 1 },\n    'east': { x: 1, y: 0 },\n    'south': { x: 0, y: 1 },\n    'north': { x: 0, y: -1 },\n    'west': { x: -1, y: 0 },\n    'southwest': { x: -1, y: 1 },\n    'northwest': { x: -1, y: -1 },\n    'northeast': { x: 1, y: -1 } // top right\n};\nvar handles = Object.keys(directions);\nvar setSize = function (domNode, sizeType, value) {\n    domNode.style[sizeType] = value + 'px';\n};\nvar reSize = /[^\\-]width:|[^\\-]height:/;\nvar reAnyValue = /^.+$/;\nvar ResizeState = /** @class */ (function () {\n    function ResizeState(activeHandle, dragging, rect, nodePosition) {\n        this.activeHandle = activeHandle;\n        this.dragging = dragging;\n        this.rect = rect;\n        this.nodePosition = nodePosition;\n    }\n    ResizeState.prototype.apply = function (tr) {\n        var state = this, next = tr.getMeta(imageResizeKey);\n        if (next) {\n            return new ResizeState(next.activeHandle, next.setDragging, next.rect, next.nodePosition);\n        }\n        return state;\n    };\n    return ResizeState;\n}());\nvar handleMouseMove = function (view, event, options) {\n    var state = imageResizeKey.getState(view.state);\n    var rect = state.rect, dragging = state.dragging, nodePosition = state.nodePosition, activeHandle = state.activeHandle;\n    if (!dragging || !rect) {\n        return;\n    }\n    var img = view.nodeDOM(nodePosition);\n    var dir = directions[activeHandle];\n    var diffX = (event.clientX - dragging.startX) * dir.x;\n    var diffY = (event.clientY - dragging.startY) * dir.y;\n    var width = dir.x ? diffX + img.width : rect.width;\n    var height = dir.y ? diffY + img.height : rect.height;\n    if (options.lockRatio && dir.x && dir.y) {\n        var ratio = Math.min(width / img.width, height / img.height);\n        var lockWidth = img.width * ratio;\n        var lockHeight = img.height * ratio;\n        dragging.startX = event.clientX - (width - lockWidth) * dir.x;\n        dragging.startY = event.clientY - (height - lockHeight) * dir.y;\n        width = lockWidth;\n        height = lockHeight;\n    }\n    else {\n        dragging.startX = dir.x ? event.clientX : dragging.startX;\n        dragging.startY = dir.y ? event.clientY : dragging.startY;\n    }\n    setSize(img, 'width', width);\n    setSize(img, 'height', height);\n    rect.top = img.offsetTop;\n    rect.left = img.offsetLeft;\n    rect.width = img.offsetWidth;\n    rect.height = img.offsetHeight;\n    var handlesWrapper = img.nextElementSibling;\n    handlesWrapper.style.width = rect.width + 'px';\n    handlesWrapper.style.height = rect.height + 'px';\n    handlesWrapper.style.top = rect.top + 'px';\n    handlesWrapper.style.left = rect.left + 'px';\n};\nvar handleMouseUp = function (view) {\n    var _a = imageResizeKey.getState(view.state), rect = _a.rect, dragging = _a.dragging, nodePosition = _a.nodePosition;\n    if (dragging && rect) {\n        var selection = view.state.selection;\n        if (selection instanceof NodeSelection) {\n            var currAttrs = selection.node.attrs;\n            var width = rect.width;\n            var height = rect.height;\n            var attrs = void 0;\n            if (reSize.test(currAttrs.style || '')) {\n                var changedWidth = changeStylesString(currAttrs.style, { style: 'width', value: reAnyValue, newValue: width + 'px' });\n                var style = changeStylesString(changedWidth.style || '', { style: 'height', value: reAnyValue, newValue: height + 'px' }).style;\n                attrs = tslib_1.__assign({}, currAttrs, { style: style });\n            }\n            else {\n                attrs = tslib_1.__assign({}, currAttrs, { width: width, height: height });\n            }\n            var newImage = selection.node.type.createAndFill(attrs);\n            if (newImage) {\n                var tr = view.state.tr;\n                tr.replaceWith(nodePosition, nodePosition + 1, newImage);\n                tr.setSelection(NodeSelection.create(tr.doc, nodePosition));\n                tr.setMeta('commandName', 'image-resize');\n                tr.setMeta('args', attrs);\n                tr.setMeta(imageResizeKey, {\n                    setDragging: null,\n                    activeHandle: null,\n                    rect: rect,\n                    nodePosition: nodePosition\n                });\n                view.dispatch(tr);\n            }\n        }\n    }\n};\nvar handleMouseDown = function (view, event, options) {\n    var target = event.target;\n    var activeHandle = target.getAttribute('data-direction');\n    if (!activeHandle) {\n        return false;\n    }\n    var resizeState = imageResizeKey.getState(view.state);\n    event.preventDefault();\n    var transaction = view.state.tr;\n    transaction.setMeta(imageResizeKey, {\n        setDragging: { startX: event.clientX, startY: event.clientY },\n        activeHandle: activeHandle,\n        rect: resizeState.rect,\n        nodePosition: resizeState.nodePosition\n    });\n    transaction.setMeta('addToHistory', false);\n    view.dispatch(transaction);\n    function move(e) {\n        handleMouseMove(view, e, options);\n    }\n    function finish(e) {\n        e.view.removeEventListener('mouseup', finish);\n        e.view.removeEventListener('mousemove', move);\n        handleMouseUp(view);\n    }\n    event.view.addEventListener('mouseup', finish);\n    event.view.addEventListener('mousemove', move);\n    return true;\n};\nexport var imageResizing = function (options) {\n    if (options === void 0) { options = { node: 'image', lockRatio: true }; }\n    return new Plugin({\n        key: imageResizeKey,\n        view: function (viewObj) { return ({\n            resize: function () {\n                if (imageResizeKey.getState(viewObj.state).rect) {\n                    viewObj.dispatch(viewObj.state.tr.setMeta('resize', true));\n                }\n            },\n            get window() {\n                return viewObj.dom.ownerDocument && viewObj.dom.ownerDocument.defaultView;\n            },\n            attachResize: function () {\n                var win = this.window;\n                if (win) {\n                    win.removeEventListener('resize', this.resize);\n                    win.addEventListener('resize', this.resize);\n                }\n            },\n            removeResize: function () {\n                var win = this.window;\n                if (win) {\n                    win.removeEventListener('resize', this.resize);\n                }\n            },\n            update: function (view, prevState) {\n                var state = view.state;\n                var selection = state.selection;\n                var nodeType = state.schema.nodes[options.node];\n                var pluginState = imageResizeKey.getState(state);\n                var prevRect = pluginState.rect;\n                if (selection instanceof NodeSelection && nodeType === selection.node.type) {\n                    var img = view.nodeDOM(selection.from);\n                    var rect = {\n                        top: img.offsetTop,\n                        left: img.offsetLeft,\n                        width: img.offsetWidth,\n                        height: img.offsetHeight\n                    };\n                    if (!prevState.selection.eq(selection) ||\n                        (prevRect && (prevRect.width !== rect.width || prevRect.height !== rect.height ||\n                            prevRect.top !== rect.top || prevRect.left !== rect.left))) {\n                        var tr = state.tr;\n                        tr.setMeta(imageResizeKey, { rect: rect, nodePosition: selection.from });\n                        view.dispatch(tr);\n                        this.attachResize();\n                    }\n                }\n                else if (prevRect) {\n                    pluginState.rect = null;\n                    pluginState.nodePosition = -1;\n                }\n            },\n            destroy: function () {\n                this.removeResize();\n            }\n        }); },\n        state: {\n            init: function () {\n                return new ResizeState('', null, null, -1);\n            },\n            apply: function (tr, prev) {\n                return prev.apply(tr);\n            }\n        },\n        props: {\n            handleDOMEvents: {\n                mousedown: function (view, event) {\n                    return handleMouseDown(view, event, options);\n                }\n            },\n            decorations: function (state) {\n                var selection = state.selection;\n                var nodeType = state.schema.nodes[options.node];\n                var rect = imageResizeKey.getState(state).rect;\n                if (rect && selection instanceof NodeSelection && nodeType === selection.node.type) {\n                    var wrapper = document.createElement('div');\n                    wrapper.className = 'k-editor-resize-handles-wrapper';\n                    wrapper.style.width = rect.width + 'px';\n                    wrapper.style.height = rect.height + 'px';\n                    wrapper.style.top = rect.top + 'px';\n                    wrapper.style.left = rect.left + 'px';\n                    for (var i = 0; i < handles.length; i++) {\n                        var dom = document.createElement('div');\n                        dom.className = 'k-editor-resize-handle ' + handles[i];\n                        dom.setAttribute('data-direction', handles[i]);\n                        wrapper.appendChild(dom);\n                    }\n                    return DecorationSet.create(state.doc, [Decoration.widget(state.selection.from + 1, wrapper)]);\n                }\n                return DecorationSet.empty;\n            }\n        }\n    });\n};\n"]},"metadata":{},"sourceType":"module"}